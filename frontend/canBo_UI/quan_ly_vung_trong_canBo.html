<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>üó∫Ô∏è Qu·∫£n l√Ω v√πng tr·ªìng</title>

    <!-- Custom fonts for this template -->
    <link
      href="../../vendor/fontawesome-free/css/all.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet"
    />

    <!-- Custom styles for this template -->
    <link href="../../css/sb-admin-2.min.css" rel="stylesheet" />

    <!-- Custom styles for this page -->
    <link
      href="../../vendor/datatables/dataTables.bootstrap4.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../vendor/jquery/jquery.min.js"></script>

    <!-- Custom styles for region detail modal -->
    <style>
      .badge-lg {
        font-size: 0.9rem;
        padding: 0.5em 0.75em;
      }

      .region-stats-card {
        transition: transform 0.2s;
      }

      .region-stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .table-responsive {
        max-height: 300px;
        overflow-y: auto;
      }

      #regionDetailModal .modal-dialog {
        max-width: 90%;
      }

      @media (max-width: 768px) {
        #regionDetailModal .modal-dialog {
          max-width: 95%;
        }
      }
    </style>
  </head>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <ul
        class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
        id="accordionSidebar"
      >
        <!-- Sidebar - Brand -->
        <a
          class="sidebar-brand d-flex align-items-center justify-content-center"
          href="./main_canBo.html"
        >
          <div class="sidebar-brand-icon rotate-n-15">
            <i class="fas fa-laugh-wink"></i>
          </div>
          <div class="sidebar-brand-text mx-3">Cam S√†nh Vƒ©nh Long</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0" />

        <!-- Nav Item - Dashboard -->
        <li class="nav-item">
          <a class="nav-link" href="./main_canBo.html">
            <i class="fas fa-fw fa-table"></i>
            <span>B√°o c√°o ‚Äì Th·ªëng k√™</span></a
          >
        </li>

        <!-- Divider -->

        <hr class="sidebar-divider" />
        <!-- Nav Item - Utilities Collapse Menu -->
        <li class="nav-item active">
          <a
            class="nav-link collapsed"
            href="./quan_ly_vung_trong_canBo.html"
            aria-expanded="true"
          >
            <i class="fa-solid fa-basket-shopping"></i>
            <span>Qu·∫£n L√Ω V√πng Tr·ªìng</span>
          </a>
        </li>
        <!-- Divider -->
        <hr class="sidebar-divider" />
        <li class="nav-item">
          <a
            class="nav-link collapsed"
            href="./theo_doi_canh_tac_canBo.html"
            aria-expanded="true"
          >
            <i class="fa-solid fa-hammer"></i>
            <span>Theo D√µi Canh T√°c</span>
          </a>
        </li>
        <hr class="sidebar-divider" />
        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
          <a class="nav-link collapsed" href="./quan_ly_sau_benh_canBo.html">
            <i class="fa-solid fa-worm"></i>
            <span>Qu·∫£n l√Ω s√¢u b·ªánh</span>
          </a>
        </li>
        <hr class="sidebar-divider" />

        <!-- Nav Item - Charts -->
        <li class="nav-item">
          <a class="nav-link" href="./ho_tro_ky_thuat_canBo.html">
            <i class="fa-solid fa-headset"></i>
            <span>H·ªó tr·ª£ k·ªπ thu·∫≠t</span></a
          >
        </li>
        <hr class="sidebar-divider" />
        <li class="nav-item">
          <a class="nav-link" href="./thong_tin_ca_nhan_canBo.html">
            <i class="fa-solid fa-user"></i>
            <span>Th√¥ng tin c√° nh√¢n</span></a
          >
        </li>
        <hr class="sidebar-divider" />
        <!-- Nav Item - Tables -->
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="confirmLogout()">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>ƒêƒÉng xu·∫•t</span>
          </a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block" />

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
          <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
      </ul>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Topbar -->
          <nav
            class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow"
          >
            <!-- Sidebar Toggle (Topbar) -->
            <button
              id="sidebarToggleTop"
              class="btn btn-link d-md-none rounded-circle mr-3"
            >
              <i class="fa fa-bars"></i>
            </button>

            <!-- Topbar Search -->
            <form
              class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search"
            >
              <div class="input-group">
                <h5>QU·∫¢N L√ù CAM S√ÄNH T·ªàNH Vƒ®NH LONG</h5>
              </div>
            </form>

            <!-- Topbar Navbar -->
            <ul class="navbar-nav ml-auto">
              <!-- Nav Item - User Information -->
              <li class="nav-item dropdown no-arrow">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="userDropdown"
                  role="button"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <span
                    class="mr-2 d-none d-lg-inline"
                    id="user-fullname"
                  ></span>
                  <img
                    class="img-profile rounded-circle"
                    id="avatar-img-mini"
                    src="../../img/undraw_profile.svg"
                  />
                  <script src="../../vendor/jquery/jquery.min.js"></script>
                  <script>
                    $(document).ready(function () {
                      let maCanBo =
                        localStorage.getItem("maCanBo") ||
                        sessionStorage.getItem("maCanBo");
                      if (!maCanBo) return;
                      $.ajax({
                        url: "../../API/api_canbo_kt.php",
                        type: "GET",
                        data: { MaCanBo: maCanBo },
                        dataType: "json",
                        success: function (res) {
                          if (res.status === "success" && res.data) {
                            const cb = res.data;
                            $("#user-fullname").text(cb.HoTen || "");
                            if (cb.avatar && cb.avatar !== "") {
                              $("#avatar-img-mini").attr(
                                "src",
                                "../../uploads/avatars/" + cb.avatar
                              );
                            } else {
                              $("#avatar-img-mini").attr(
                                "src",
                                "../../img/undraw_profile.svg"
                              );
                            }
                          }
                        },
                      });
                    });
                  </script>
                </a>
                <!-- Dropdown - User Information -->
                <div
                  class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                  aria-labelledby="userDropdown"
                >
                  <a
                    class="dropdown-item"
                    href="./thong_tin_ca_nhan_canBo.html"
                  >
                    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                    Trang c√° nh√¢n
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#" onclick="confirmLogout()">
                    <i
                      class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"
                    ></i>
                    ƒêƒÉng xu·∫•t
                  </a>
                </div>
              </li>
            </ul>
          </nav>
          <!-- End of Topbar -->

          <!-- Begin Page Content -->
          <div class="container-fluid">
            <!-- Page Heading -->
            <div
              class="d-sm-flex align-items-center justify-content-between mb-4"
            >
              <h1 class="h3 mb-0 text-gray-800">üó∫Ô∏è Qu·∫£n L√Ω V√πng Tr·ªìng</h1>
              <div>
                <button
                  class="btn btn-info btn-sm shadow-sm mr-2"
                  id="addPlotBtn"
                >
                  <i class="fas fa-map"></i> Th√™m th·ª≠a ƒë·∫•t
                </button>
                <button
                  class="btn btn-primary btn-sm shadow-sm"
                  id="addRegionBtn"
                >
                  <i class="fas fa-plus"></i> Th√™m v√πng tr·ªìng
                </button>
              </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="managementTabs" role="tablist">
              <li class="nav-item">
                <a
                  class="nav-link active"
                  id="regions-tab"
                  data-toggle="tab"
                  href="#regions"
                  role="tab"
                >
                  <i class="fas fa-map-marked-alt"></i> V√πng tr·ªìng
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="plots-tab"
                  data-toggle="tab"
                  href="#plots"
                  role="tab"
                >
                  <i class="fas fa-map"></i> Th·ª≠a ƒë·∫•t
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="farmers-tab"
                  data-toggle="tab"
                  href="#farmers"
                  role="tab"
                >
                  <i class="fas fa-users"></i> N√¥ng h·ªô
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="crops-tab"
                  data-toggle="tab"
                  href="#crops"
                  role="tab"
                >
                  <i class="fas fa-seedling"></i> M√πa v·ª• & C√¢y tr·ªìng
                </a>
              </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="managementTabsContent">
              <!-- V√πng tr·ªìng Tab -->
              <div
                class="tab-pane fade show active"
                id="regions"
                role="tabpanel"
              >
                <div class="card shadow mt-3">
                  <div class="card-header py-3">
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <h6 class="m-0 font-weight-bold text-primary">
                          üìã Danh s√°ch v√πng tr·ªìng
                        </h6>
                      </div>
                      <div class="col-md-6">
                        <div class="row">
                          <div class="col-md-6">
                            <input
                              type="text"
                              class="form-control form-control-sm"
                              id="searchRegion"
                              placeholder="üîç T√¨m ki·∫øm v√πng..."
                            />
                          </div>
                          <div class="col-md-6">
                            <select
                              class="form-control form-control-sm"
                              id="filterRegionStatus"
                            >
                              <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                              <option value="1">Ho·∫°t ƒë·ªông</option>
                              <option value="0">Kh√¥ng ho·∫°t ƒë·ªông</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Th·ªëng k√™ nhanh -->
                    <div class="row mb-3">
                      <div class="col-md-3">
                        <div class="card border-left-primary shadow-sm">
                          <div class="card-body p-3">
                            <div class="text-xs font-weight-bold text-primary">
                              T·ªïng v√πng tr·ªìng
                            </div>
                            <div
                              class="h6 mb-0 font-weight-bold"
                              id="totalRegions"
                            >
                              0
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card border-left-success shadow-sm">
                          <div class="card-body p-3">
                            <div class="text-xs font-weight-bold text-success">
                              T·ªïng di·ªán t√≠ch (ha)
                            </div>
                            <div
                              class="h6 mb-0 font-weight-bold"
                              id="totalArea"
                            >
                              0
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card border-left-info shadow-sm">
                          <div class="card-body p-3">
                            <div class="text-xs font-weight-bold text-info">
                              T·ªïng n√¥ng h·ªô
                            </div>
                            <div
                              class="h6 mb-0 font-weight-bold"
                              id="totalFarmers"
                            >
                              0
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card border-left-warning shadow-sm">
                          <div class="card-body p-3">
                            <div class="text-xs font-weight-bold text-warning">
                              V√πng ho·∫°t ƒë·ªông
                            </div>
                            <div
                              class="h6 mb-0 font-weight-bold"
                              id="activeRegions"
                            >
                              0
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- B·∫£ng v√πng tr·ªìng -->
                    <div class="table-responsive">
                      <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="5%">STT</th>
                            <th width="10%">M√£ v√πng</th>
                            <th width="20%">T√™n v√πng</th>
                            <th width="25%">ƒê·ªãa ch·ªâ</th>
                            <th width="10%">Di·ªán t√≠ch</th>
                            <th width="8%">N√¥ng h·ªô</th>
                            <th width="10%">Tr·∫°ng th√°i</th>
                            <th width="12%">Thao t√°c</th>
                          </tr>
                        </thead>
                        <tbody id="regionsTableBody">
                          <tr>
                            <td colspan="8" class="text-center">
                              <div
                                class="spinner-border text-primary"
                                role="status"
                              >
                                <span class="sr-only">ƒêang t·∫£i...</span>
                              </div>
                              <p class="mt-2">
                                ƒêang t·∫£i danh s√°ch v√πng tr·ªìng...
                              </p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Th·ª≠a ƒë·∫•t Tab -->
              <div class="tab-pane fade" id="plots" role="tabpanel">
                <div class="card shadow mt-3">
                  <div class="card-header py-3">
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <h6 class="m-0 font-weight-bold text-primary">
                          üó∫Ô∏è Qu·∫£n l√Ω th·ª≠a ƒë·∫•t
                        </h6>
                      </div>
                      <div class="col-md-6">
                        <div class="row">
                          <div class="col-md-6">
                            <select
                              class="form-control form-control-sm"
                              id="filterPlotRegion"
                            >
                              <option value="">T·∫•t c·∫£ v√πng tr·ªìng</option>
                            </select>
                          </div>
                          <div class="col-md-6">
                            <input
                              type="text"
                              class="form-control form-control-sm"
                              id="searchPlot"
                              placeholder="üîç T√¨m ki·∫øm th·ª≠a..."
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="5%">STT</th>
                            <th width="10%">M√£ th·ª≠a</th>
                            <th width="15%">V√πng tr·ªìng</th>
                            <th width="15%">N√¥ng h·ªô</th>
                            <th width="15%">Lo·∫°i ƒë·∫•t</th>
                            <th width="10%">Di·ªán t√≠ch</th>
                            <th width="20%">V·ªã tr√≠</th>
                            <th width="10%">Thao t√°c</th>
                          </tr>
                        </thead>
                        <tbody id="plotsTableBody">
                          <tr>
                            <td colspan="8" class="text-center">
                              <p class="text-muted">
                                Ch·ªçn tab "Th·ª≠a ƒë·∫•t" ƒë·ªÉ xem d·ªØ li·ªáu
                              </p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- N√¥ng h·ªô Tab -->
              <div class="tab-pane fade" id="farmers" role="tabpanel">
                <div class="card shadow mt-3">
                  <div class="card-header py-3">
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <h6 class="m-0 font-weight-bold text-primary">
                          üë• Qu·∫£n l√Ω n√¥ng h·ªô
                        </h6>
                      </div>
                      <div class="col-md-6">
                        <div class="row">
                          <div class="col-md-4">
                            <select
                              class="form-control form-control-sm"
                              id="filterFarmerRegion"
                            >
                              <option value="">T·∫•t c·∫£ v√πng tr·ªìng</option>
                            </select>
                          </div>
                          <div class="col-md-4">
                            <input
                              type="text"
                              class="form-control form-control-sm"
                              id="searchFarmer"
                              placeholder="üîç T√¨m ki·∫øm n√¥ng h·ªô..."
                            />
                          </div>
                          <button
                            class="btn btn-success btn-sm"
                            id="addFarmerBtn"
                          >
                            <i class="fa-solid fa-plus"></i> Th√™m n√¥ng h·ªô
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                          <tr>
                            <th width="5%">STT</th>
                            <th width="10%">M√£ n√¥ng h·ªô</th>
                            <th width="20%">H·ªç t√™n</th>
                            <th width="15%">V√πng tr·ªìng</th>
                            <th width="15%">S·ªë ƒëi·ªán tho·∫°i</th>
                            <th width="20%">ƒê·ªãa ch·ªâ</th>
                            <th width="8%">S·ªë th·ª≠a</th>
                            <th width="7%">Thao t√°c</th>
                          </tr>
                        </thead>
                        <tbody id="farmersTableBody">
                          <tr>
                            <td colspan="8" class="text-center">
                              <p class="text-muted">
                                Ch·ªçn tab "N√¥ng h·ªô" ƒë·ªÉ xem d·ªØ li·ªáu
                              </p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- M√πa v·ª• & C√¢y tr·ªìng Tab -->
              <div class="tab-pane fade" id="crops" role="tabpanel">
                <div class="card shadow mt-3">
                  <div class="card-header py-3">
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <h6 class="m-0 font-weight-bold text-primary">
                          üå± Qu·∫£n l√Ω m√πa v·ª• & c√¢y tr·ªìng
                        </h6>
                      </div>
                      <div class="col-md-6">
                        <div class="row">
                          <div class="col-md-4">
                            <select
                              class="form-control form-control-sm"
                              id="filterCropSeason"
                            >
                              <option value="">T·∫•t c·∫£ v·ª• m√πa</option>
                            </select>
                          </div>
                          <div class="col-md-4">
                            <!-- Thay ƒë·ªïi text button -->
                            <button
                              class="btn btn-success btn-sm"
                              id="addCropBtn"
                            >
                              <i class="fas fa-seedling"></i> Th√™m
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Th√™m sub-tabs cho M√πa v·ª• v√† Gi·ªëng cam -->
                    <ul
                      class="nav nav-pills mb-3"
                      id="cropSubTabs"
                      role="tablist"
                    >
                      <li class="nav-item">
                        <a
                          class="nav-link active"
                          id="seasons-subtab"
                          data-toggle="pill"
                          href="#seasons-content"
                          role="tab"
                        >
                          üìÖ M√πa v·ª•
                        </a>
                      </li>
                      <li class="nav-item">
                        <a
                          class="nav-link"
                          id="varieties-subtab"
                          data-toggle="pill"
                          href="#varieties-content"
                          role="tab"
                        >
                          üçä Gi·ªëng cam
                        </a>
                      </li>
                    </ul>

                    <!-- Sub-tab content -->
                    <div class="tab-content" id="cropSubTabsContent">
                      <!-- M√πa v·ª• content -->
                      <div
                        class="tab-pane fade show active"
                        id="seasons-content"
                        role="tabpanel"
                      >
                        <div class="table-responsive">
                          <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                              <tr>
                                <th width="5%">STT</th>
                                <th width="15%">M√£ v·ª•</th>
                                <th width="25%">T√™n v·ª• m√πa</th>
                                <th width="20%">Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
                                <th width="20%">Th·ªùi gian k·∫øt th√∫c</th>
                                <th width="15%">Thao t√°c</th>
                              </tr>
                            </thead>
                            <tbody id="seasonsTableBody">
                              <tr>
                                <td colspan="6" class="text-center">
                                  <p class="text-muted">
                                    Ch·ªçn tab "M√πa v·ª•" ƒë·ªÉ xem d·ªØ li·ªáu
                                  </p>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <!-- Gi·ªëng cam content -->
                      <div
                        class="tab-pane fade"
                        id="varieties-content"
                        role="tabpanel"
                      >
                        <div class="table-responsive">
                          <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                              <tr>
                                <th width="5%">STT</th>
                                <th width="15%">M√£ gi·ªëng</th>
                                <th width="20%">T√™n gi·ªëng</th>
                                <th width="30%">ƒê·∫∑c t√≠nh</th>
                                <th width="20%">Ngu·ªìn g·ªëc</th>
                                <th width="10%">Thao t√°c</th>
                              </tr>
                            </thead>
                            <tbody id="varietiesTableBody">
                              <tr>
                                <td colspan="7" class="text-center">
                                  <p class="text-muted">
                                    Ch·ªçn tab "Gi·ªëng cam" ƒë·ªÉ xem d·ªØ li·ªáu
                                  </p>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              <span>Copyright &copy; Cam S√†nh Vƒ©nh Long 2024</span>
            </div>
          </div>
        </footer>
        <!-- End of Footer -->
      </div>
      <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Modal V√πng tr·ªìng -->
    <div class="modal fade" id="regionModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="regionModalTitle">
              Th√™m v√πng tr·ªìng m·ªõi
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="regionForm">
              <input type="hidden" id="regionId" />
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="regionName">T√™n v√πng tr·ªìng *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="regionName"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="regionArea">Di·ªán t√≠ch (km)*</label>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      id="regionArea"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="regionProvince">T·ªânh *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="regionProvince"
                      value="Vƒ©nh Long"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="regionDistrict">Huy·ªán *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="regionDistrict"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="regionWard">X√£/Ph∆∞·ªùng *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="regionWard"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="regionAddress">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                <textarea
                  class="form-control"
                  id="regionAddress"
                  rows="2"
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="regionHouseholds">S·ªë h·ªô d√¢n</label>
                    <input
                      type="number"
                      class="form-control"
                      id="regionHouseholds"
                      min="0"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="regionStatus">Tr·∫°ng th√°i</label>
                    <select class="form-control" id="regionStatus">
                      <option value="1">Ho·∫°t ƒë·ªông</option>
                      <option value="0">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="regionDescription">M√¥ t·∫£</label>
                <textarea
                  class="form-control"
                  id="regionDescription"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              H·ªßy
            </button>
            <button type="button" class="btn btn-primary" id="saveRegionBtn">
              L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Th·ª≠a ƒë·∫•t -->
    <div class="modal fade" id="plotModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="plotModalTitle">Th√™m th·ª≠a ƒë·∫•t m·ªõi</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="plotForm">
              <input type="hidden" id="plotId" />
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="plotRegion">V√πng tr·ªìng *</label>
                    <select class="form-control" id="plotRegion" required>
                      <option value="">Ch·ªçn v√πng tr·ªìng...</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="plotFarmer">N√¥ng h·ªô *</label>
                    <select class="form-control" id="plotFarmer" required>
                      <option value="">Ch·ªçn n√¥ng h·ªô...</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="plotArea">Di·ªán t√≠ch (km)*</label>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      id="plotArea"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="plotType">Lo·∫°i ƒë·∫•t *</label>
                    <select class="form-control" id="plotType" required>
                      <option value="">Ch·ªçn lo·∫°i ƒë·∫•t...</option>
                      <option value="ƒê·∫•t ph√π sa">ƒê·∫•t ph√π sa</option>
                      <option value="ƒê·∫•t c√°t">ƒê·∫•t c√°t</option>
                      <option value="ƒê·∫•t s√©t">ƒê·∫•t s√©t</option>
                      <option value="ƒê·∫•t pha">ƒê·∫•t pha</option>
                      <option value="ƒê·∫•t m·∫∑n">ƒê·∫•t m·∫∑n</option>
                      <option value="ƒê·∫•t chua">ƒê·∫•t chua</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="plotLocation">V·ªã tr√≠ th·ª≠a ƒë·∫•t *</label>
                <textarea
                  class="form-control"
                  id="plotLocation"
                  rows="3"
                  required
                  placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt c·ªßa th·ª≠a ƒë·∫•t..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              H·ªßy
            </button>
            <button type="button" class="btn btn-primary" id="savePlotBtn">
              L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ch·ªânh s·ª≠a n√¥ng h·ªô -->
    <div class="modal fade" id="editFarmerModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editFarmerModalTitle">
              Ch·ªânh s·ª≠a th√¥ng tin n√¥ng h·ªô
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editFarmerForm">
              <input type="hidden" id="editFarmerId" />
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editFarmerName">H·ªç t√™n *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="editFarmerName"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editFarmerGender">Gi·ªõi t√≠nh</label>
                    <select class="form-control" id="editFarmerGender">
                      <option value="Nam">Nam</option>
                      <option value="N·ªØ">N·ªØ</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editFarmerPhone">S·ªë ƒëi·ªán tho·∫°i *</label>
                    <input
                      type="tel"
                      class="form-control"
                      id="editFarmerPhone"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editFarmerEmail">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="editFarmerEmail"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editFarmerBirthdate">Ng√†y sinh</label>
                    <input
                      type="date"
                      class="form-control"
                      id="editFarmerBirthdate"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="editFarmerRegion">V√πng tr·ªìng *</label>
                    <select class="form-control" id="editFarmerRegion" required>
                      <option value="">Ch·ªçn v√πng tr·ªìng...</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="editFarmerAddress">ƒê·ªãa ch·ªâ *</label>
                <textarea
                  class="form-control"
                  id="editFarmerAddress"
                  rows="3"
                  required
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              H·ªßy
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="saveEditFarmerBtn"
            >
              C·∫≠p nh·∫≠t
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Gi·ªëng cam -->
    <div class="modal fade" id="varietyModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="varietyModalTitle">
              Th√™m gi·ªëng cam m·ªõi
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="varietyForm">
              <input type="hidden" id="varietyId" />
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="varietyName">T√™n gi·ªëng cam *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="varietyName"
                      required
                      placeholder="VD: Cam s√†nh, Cam canh..."
                    />
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="varietyCharacteristics">ƒê·∫∑c t√≠nh *</label>
                <textarea
                  class="form-control"
                  id="varietyCharacteristics"
                  rows="3"
                  required
                  placeholder="M√¥ t·∫£ ƒë·∫∑c t√≠nh c·ªßa gi·ªëng cam..."
                ></textarea>
              </div>
              <div class="form-group">
                <label for="varietyOrigin">Ngu·ªìn g·ªëc *</label>
                <input
                  type="text"
                  class="form-control"
                  id="varietyOrigin"
                  required
                  placeholder="VD: Vi·ªát Nam, Nh·∫≠t B·∫£n, Trung Qu·ªëc..."
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              H·ªßy
            </button>
            <button type="button" class="btn btn-primary" id="saveVarietyBtn">
              L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Chi ti·∫øt n√¥ng h·ªô -->
    <div class="modal fade" id="farmerDetailModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="farmerDetailModalTitle">
              Chi ti·∫øt n√¥ng h·ªô
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="farmerDetailContent">
              <!-- N·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Chi ti·∫øt v√πng tr·ªìng -->
    <div class="modal fade" id="regionDetailModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="regionDetailModalTitle">
              Chi ti·∫øt v√πng tr·ªìng
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="regionDetailContent">
              <!-- N·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal M√πa v·ª• -->
    <div class="modal fade" id="seasonModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="seasonModalTitle">Th√™m m√πa v·ª• m·ªõi</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="seasonForm">
              <input type="hidden" id="seasonId" />
              <div class="form-group">
                <label for="seasonName">T√™n m√πa v·ª• *</label>
                <input
                  type="text"
                  class="form-control"
                  id="seasonName"
                  required
                  placeholder="VD: V·ª• xu√¢n, V·ª• m√πa..."
                />
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="seasonStartDate">Ng√†y b·∫Øt ƒë·∫ßu *</label>
                    <input
                      type="date"
                      class="form-control"
                      id="seasonStartDate"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="seasonEndDate">Ng√†y k·∫øt th√∫c* </label>
                    <input
                      type="date"
                      class="form-control"
                      id="seasonEndDate"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="seasonDescription">M√¥ t·∫£</label>
                <textarea
                  class="form-control"
                  id="seasonDescription"
                  rows="3"
                  placeholder="M√¥ t·∫£ v·ªÅ m√πa v·ª•..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              H·ªßy
            </button>
            <button type="button" class="btn btn-primary" id="saveSeasonBtn">
              L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <script src="../../js/session_check_canBo.js"></script>
    <script>
      let canBoFullName = localStorage.getItem("canBoFullName");
      if (canBoFullName) {
        $("#user-fullname").text(canBoFullName || "C√°n b·ªô");
      } else {
        $("#user-fullname").text("C√°n b·ªô");
      }

      // Modal HTML cho th√™m n√¥ng h·ªô
      const addFarmerModalHtml = `
      <div class="modal fade" id="addFarmerModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Th√™m n√¥ng h·ªô m·ªõi</h5>
              <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
              <form id="addFarmerForm">
                <div class="form-group">
                  <label for="ho-ten">H·ªç t√™n *</label>
                  <input type="text" class="form-control" id="ho-ten" name="ho-ten" required />
                </div>
                <div class="form-group">
                  <label for="gioi-tinh">Gi·ªõi t√≠nh *</label>
                  <select class="form-control" id="gioi-tinh" name="gioi-tinh" required>
                    <option value="Nam">Nam</option>
                    <option value="N·ªØ">N·ªØ</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="ngay-sinh">Ng√†y sinh *</label>
                  <input type="date" class="form-control" id="ngay-sinh" name="ngay-sinh" required />
                </div>
                <div class="form-group">
                <label for="gio-sinh">Gi·ªù sinh *</label>
                <input
                  type="time"
                  step="1"
                  class="form-control"
                  id="gio-sinh"
                  name="gio-sinh"
                  required
                />
              </div>
                <div class="form-group">
                  <label for="tinh">T·ªânh *</label>
                  <select class="form-control" id="tinh" name="tinh" required></select>
                </div>
                <div class="form-group">
                  <label for="huyen">Huy·ªán *</label>
                  <select class="form-control" id="huyen" name="huyen" required disabled></select>
                </div>
                <div class="form-group">
                  <label for="xa">X√£ *</label>
                  <select class="form-control" id="xa" name="xa" required disabled></select>
                </div>
                <div class="form-group">
                  <label for="ap">·∫§p *</label>
                  <select class="form-control" id="ap" name="ap" required disabled></select>
                </div>
                <div class="form-group">
                  <label for="diaChi">ƒê·ªãa ch·ªâ </label>
                  <input type="text" class="form-control" id="diaChi" name="diaChi" />
                </div>
                <div class="form-group">
                  <label for="sdt">S·ªë ƒëi·ªán tho·∫°i *</label>
                  <input type="tel" class="form-control" id="sdt" name="sdt" required />
                </div>
                <div class="form-group">
                  <label for="email">Email *</label>
                  <input type="email" class="form-control" id="email" name="email" required />
                </div>
                <div class="form-group">
                  <label for="pass">M·∫≠t kh·∫©u t√†i kho·∫£n *</label>
                  <input type="password" class="form-control" id="pass" name="pass" required />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
              <button type="button" class="btn btn-primary" id="saveAddFarmerBtn">L∆∞u</button>
            </div>
          </div>
        </div>
      </div>`;

      // Th√™m modal v√†o body n·∫øu ch∆∞a c√≥
      if ($("#addFarmerModal").length === 0) {
        $("body").append(addFarmerModalHtml);
      }

      let diaChiData = {};
      // G·ªçi API l·∫•y d·ªØ li·ªáu ƒë·ªãa ch·ªâ khi trang load
      $.ajax({
        url: "../../API/api_du_lieu_dia_chi_vt.php",
        method: "GET",
        dataType: "json",
        xhrFields: { withCredentials: true },
        success: function (res) {
          if (res.status === "success" && res.data) {
            diaChiData = res.data;
            const tinhSelect = $("#tinh");
            tinhSelect.empty().append('<option value="">Ch·ªçn t·ªânh</option>');
            Object.keys(diaChiData).forEach((tinh) => {
              tinhSelect.append(`<option value="${tinh}">${tinh}</option>`);
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë·ªãa ch·ªâ!",
              confirmButtonColor: "#d33",
            });
          }
        },
        error: function () {
          Swal.fire({
            icon: "error",
            title: "L·ªói k·∫øt n·ªëi API ƒë·ªãa ch·ªâ!",
            confirmButtonColor: "#d33",
          });
        },
      });

      // X·ª≠ l√Ω khi ch·ªçn t·ªânh
      $(document).on("change", "#tinh", function () {
        const tinh = $(this).val();
        const huyenSelect = $("#huyen");
        const xaSelect = $("#xa");
        const apSelect = $("#ap");
        huyenSelect
          .empty()
          .append('<option value="">Ch·ªçn huy·ªán</option>')
          .prop("disabled", !tinh);
        xaSelect
          .empty()
          .append('<option value="">Ch·ªçn x√£</option>')
          .prop("disabled", true);
        apSelect
          .empty()
          .append('<option value="">Ch·ªçn ·∫•p</option>')
          .prop("disabled", true);
        if (tinh && diaChiData[tinh]) {
          Object.keys(diaChiData[tinh]).forEach((huyen) => {
            huyenSelect.append(`<option value="${huyen}">${huyen}</option>`);
          });
        }
        updateDiaChi();
      });
      // X·ª≠ l√Ω khi ch·ªçn huy·ªán
      $(document).on("change", "#huyen", function () {
        const tinh = $("#tinh").val();
        const huyen = $(this).val();
        const xaSelect = $("#xa");
        const apSelect = $("#ap");
        xaSelect
          .empty()
          .append('<option value="">Ch·ªçn x√£</option>')
          .prop("disabled", !huyen);
        apSelect
          .empty()
          .append('<option value="">Ch·ªçn ·∫•p</option>')
          .prop("disabled", true);
        if (tinh && huyen && diaChiData[tinh][huyen]) {
          Object.keys(diaChiData[tinh][huyen]).forEach((xa) => {
            xaSelect.append(`<option value="${xa}">${xa}</option>`);
          });
        }
        updateDiaChi();
      });
      // X·ª≠ l√Ω khi ch·ªçn x√£
      $(document).on("change", "#xa", function () {
        const tinh = $("#tinh").val();
        const huyen = $("#huyen").val();
        const xa = $(this).val();
        const apSelect = $("#ap");
        apSelect
          .empty()
          .append('<option value="">Ch·ªçn ·∫•p</option>')
          .prop("disabled", !xa);
        if (tinh && huyen && xa && diaChiData[tinh][huyen][xa]) {
          diaChiData[tinh][huyen][xa].forEach((ap) => {
            apSelect.append(`<option value="${ap}">${ap}</option>`);
          });
        }
        updateDiaChi();
      });
      // X·ª≠ l√Ω khi ch·ªçn ·∫•p
      $(document).on("change", "#ap", function () {
        updateDiaChi();
      });

      // H√†m c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ ho√†n ch·ªânh
      function updateDiaChi() {
        const tinh = $("#tinh").val();
        const huyen = $("#huyen").val();
        const xa = $("#xa").val();
        const ap = $("#ap").val();
        let diaChiObj = {};
        if (ap) diaChiObj.ap = ap;
        if (xa) diaChiObj.xa = xa;
        if (huyen) diaChiObj.huyen = huyen;
        if (tinh) diaChiObj.tinh = tinh;
        const diaChi = Object.values(diaChiObj).filter(Boolean).join(", ");
        console.log("C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ:", diaChi);
      }

      // X·ª≠ l√Ω khi b·∫•m n√∫t Th√™m n√¥ng h·ªô
      $(document).on("click", "#addFarmerBtn", function () {
        $("#addFarmerModal").modal("show");
        // Reset form khi m·ªü modal
        $("#addFarmerForm")[0].reset();
        $("#huyen, #xa, #ap").prop("disabled", true);
        $("#diaChi").val("");
      });
      // X·ª≠ l√Ω khi b·∫•m n√∫t L∆∞u trong modal Th√™m n√¥ng h·ªô
      $(document).on("click", "#saveAddFarmerBtn", function () {
        const hoTen = $("#ho-ten").val().trim();
        const gioiTinh = $("#gioi-tinh").val();
        const ngaySinh = $("#ngay-sinh").val();
        const gioSinh = $("#gio-sinh").val();
        const tinh = $("#tinh").val();
        const huyen = $("#huyen").val();
        const xa = $("#xa").val();
        const ap = $("#ap").val();
        const sdt = $("#sdt").val().trim();
        const email = $("#email").val().trim();
        const pass = $("#pass").val().trim();
        const diaChi = $("#diaChi").val().trim();
        const ngaySinhFull = ngaySinh + " " + gioSinh;
        // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
        if (
          !hoTen ||
          !tinh ||
          !huyen ||
          !xa ||
          !ap ||
          !ngaySinh ||
          !gioSinh ||
          !gioiTinh ||
          !pass ||
          !sdt ||
          !email
        ) {
          Swal.fire({
            icon: "warning",
            title: "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!",
            confirmButtonColor: "#d33",
          });
          return;
        }

        console.log("Th√¥ng tin n√¥ng h·ªô:", {
          hoTen,
          gioiTinh,
          ngaySinhFull,
          tinh,
          huyen,
          xa,
          ap,
          sdt,
          email,
          diaChi,
          pass,
        });

        let dataSend = {
          hoTen: hoTen,
          gioiTinh: gioiTinh,
          ngaySinh: ngaySinhFull,
          tinh: tinh,
          huyen: huyen,
          xa: xa,
          ap: ap,
          sdt: sdt,
          email: email,
          diaChi: diaChi,
          pass: pass,
        };

        // G·ªçi API th√™m n√¥ng h·ªô

        $.ajax({
          url: "../../API/api_quan_ly_nong_ho.php",
          method: "POST",
          data: JSON.stringify(dataSend),
          contentType: "application/json",
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              Swal.fire({
                icon: "success",
                title: "Th√™m n√¥ng h·ªô th√†nh c√¥ng!",
                confirmButtonColor: "#28a745",
              }).then(() => {
                $("#addFarmerModal").modal("hide");
                loadFarmers(); // T·∫£i l·∫°i danh s√°ch n√¥ng h·ªô
              });
            } else {
              Swal.fire({
                icon: "error",
                title: `L·ªói: ${res.message}`,
                confirmButtonColor: "#d33",
              });
            }
          },
          error: function (e) {
            Swal.fire({
              icon: "error",
              title: "L·ªói k·∫øt n·ªëi API!",
              confirmButtonColor: "#d33",
            });
            console.log("Error adding farmer:", e);
          },
        });
      });
    </script>
    <script>
      // Global variables
      let allRegions = [];
      let allPlots = [];
      let allFarmers = [];
      let allCrops = [];
      let allSeasons = [];
      let allVarieties = [];

      $(document).on("sessionValid", function (event, sessionData) {
        console.log("Session valid, loading data...");
        initializeData();
      });

      function initializeData() {
        loadRegions();
        loadPlots(false); // Load d·ªØ li·ªáu th·ª≠a ƒë·∫•t ngay t·ª´ ƒë·∫ßu nh∆∞ng kh√¥ng hi·ªÉn th·ªã spinner
        loadFarmersForDropdown(); // Load d·ªØ li·ªáu n√¥ng h·ªô cho dropdown
        loadDropdownData();
      }

      // Load all regions
      function loadRegions() {
        $("#regionsTableBody").html(`
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">ƒêang t·∫£i...</span>
                  </div>
                  <p class="mt-2">ƒêang t·∫£i danh s√°ch v√πng tr·ªìng...</p>
                </td>
              </tr>
            `);

        $.ajax({
          url: "../../API/api_quan_ly_vung_trong.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              allRegions = res.data || [];
              renderRegionsTable(allRegions);
              updateRegionStats();
              populateRegionDropdowns();
            } else {
              $("#regionsTableBody").html(`
                    <tr>
                      <td colspan="8" class="text-center text-danger">
                        L·ªói: ${res.message}
                      </td>
                    </tr>
                  `);
            }
          },
          error: function (xhr, status, error) {
            console.error("Error loading regions:", error);
            $("#regionsTableBody").html(`
                  <tr>
                    <td colspan="8" class="text-center text-danger">
                      C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu
                    </td>
                  </tr>
                `);
          },
        });
      }

      // Load farmers for dropdown (without showing spinner)
      function loadFarmersForDropdown() {
        $.ajax({
          url: "../../API/api_quan_ly_nong_ho.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              allFarmers = res.data || [];
              populateFarmerDropdowns();
            }
          },
          error: function (xhr, status, error) {
            console.error("Error loading farmers for dropdown:", error);
          },
        });
      }

      // Load dropdown data
      function loadDropdownData() {
        // Load seasons
        $.ajax({
          url: "../../API/api_quan_ly_vu_mua.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              allSeasons = res.data || [];
              populateSeasonDropdowns();
            }
          },
        });

        // Load varieties
        $.ajax({
          url: "../../API/api_quan_ly_cay_trong.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              allVarieties = res.data || [];
              populateVarietyDropdowns();
            }
          },
        });
      }

      // Load data by tab
      function loadTabData(tabName) {
        switch (tabName) {
          case "plots":
            loadPlots();
            break;
          case "farmers":
            loadFarmers();
            break;
          case "crops":
            loadCrops();
            break;
        }
      }

      // Load plots
      function loadPlots(showSpinner = true) {
        if (showSpinner) {
          $("#plotsTableBody").html(`
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">ƒêang t·∫£i...</span>
                  </div>
                  <p class="mt-2">ƒêang t·∫£i danh s√°ch th·ª≠a ƒë·∫•t...</p>
                </td>
              </tr>
            `);
        }

        $.ajax({
          url: "../../API/api_quan_ly_thua_dat.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              allPlots = res.data || [];
              console.log("All plots loaded:", allPlots);
              console.log(
                "Plot regions mapping:",
                allPlots.map((p) => ({ MaThua: p.MaThua, MaVung: p.MaVung }))
              );
              if (showSpinner) {
                renderPlotsTable(allPlots);
              }
            } else {
              if (showSpinner) {
                $("#plotsTableBody").html(`
                    <tr>
                      <td colspan="8" class="text-center text-danger">
                        L·ªói: ${res.message}
                      </td>
                    </tr>
                  `);
              }
            }
          },
          error: function (xhr, status, error) {
            console.error("Error loading plots:", error);
            if (showSpinner) {
              $("#plotsTableBody").html(`
                  <tr>
                    <td colspan="8" class="text-center text-danger">
                      C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu th·ª≠a ƒë·∫•t
                    </td>
                  </tr>
                `);
            }
          },
        });
      }

      // Load farmers
      function loadFarmers() {
        $("#farmersTableBody").html(`
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">ƒêang t·∫£i...</span>
                  </div>
                  <p class="mt-2">ƒêang t·∫£i danh s√°ch n√¥ng h·ªô...</p>
                </td>
              </tr>
            `);

        $.ajax({
          url: "../../API/api_quan_ly_nong_ho.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              allFarmers = res.data || [];
              renderFarmersTable(allFarmers);
            } else {
              $("#farmersTableBody").html(`
                    <tr>
                      <td colspan="8" class="text-center text-danger">
                        L·ªói: ${res.message}
                      </td>
                    </tr>
                  `);
            }
          },
          error: function (xhr, status, error) {
            console.error("Error loading farmers:", error);
            $("#farmersTableBody").html(`
                  <tr>
                    <td colspan="8" class="text-center text-danger">
                      C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu n√¥ng h·ªô
                    </td>
                  </tr>
                `);
          },
        });
      }

      // Load crops
      function loadCrops() {
        // Load d·ªØ li·ªáu cho sub-tab ƒëang active
        const activeSubTab = $("#cropSubTabs .nav-link.active").attr("href");

        if (activeSubTab === "#varieties-content") {
          loadVarieties(); // Load gi·ªëng cam
        } else {
          loadSeasons(); // Load m√πa v·ª•
        }
      }

      // Render functions
      function renderRegionsTable(regions) {
        const tbody = $("#regionsTableBody");
        tbody.empty();

        if (regions.length === 0) {
          tbody.html(`
                <tr>
                  <td colspan="8" class="text-center">
                    <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i><br>
                    <p class="text-muted">Ch∆∞a c√≥ v√πng tr·ªìng n√†o</p>
                  </td>
                </tr>
              `);
          return;
        }

        regions.forEach((region, index) => {
          const statusBadge =
            region.TrangThai == 1
              ? '<span class="badge badge-success">Ho·∫°t ƒë·ªông</span>'
              : '<span class="badge badge-secondary">Kh√¥ng ho·∫°t ƒë·ªông</span>';

          const address = [region.DiaChi, region.Xa, region.Huyen, region.Tinh]
            .filter(Boolean)
            .join(", ");

          const row = `
                <tr>
                  <td class="text-center font-weight-bold">${index + 1}</td>
                  <td class="font-weight-bold text-primary">VT${region.MaVung.toString().padStart(
                    3,
                    "0"
                  )}</td>
                  <td>
                    <span class="font-weight-bold">üó∫Ô∏è ${
                      region.TenVung || "Ch∆∞a c√≥ t√™n"
                    }</span>
                  </td>
                  <td><small class="text-muted">${address}</small></td>
                  <td class="text-center">
                    <span class="badge badge-info">${
                      region.DienTich || 0
                    } ha</span>
                  </td>
                  <td class="text-center">${region.SoHoDan || 0}</td>
                  <td class="text-center">${statusBadge}</td>
                  <td class="text-center">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-info" onclick="viewRegionDetails(${
                        region.MaVung
                      })" title="Xem chi ti·∫øt">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-warning" onclick="editRegion(${
                        region.MaVung
                      })" title="Ch·ªânh s·ª≠a">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteRegion(${
                        region.MaVung
                      })" title="X√≥a">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
          tbody.append(row);
        });
      }

      function renderPlotsTable(plots) {
        const tbody = $("#plotsTableBody");
        tbody.empty();

        if (plots.length === 0) {
          tbody.html(`
                <tr>
                  <td colspan="8" class="text-center">
                    <i class="fas fa-map fa-3x text-muted mb-3"></i><br>
                    <p class="text-muted">Ch∆∞a c√≥ th·ª≠a ƒë·∫•t n√†o</p>
                  </td>
                </tr>
              `);
          return;
        }

        plots.forEach((plot, index) => {
          const region = allRegions.find((r) => r.MaVung == plot.MaVung);
          const farmer = allFarmers.find((f) => f.MaHo == plot.MaHo);

          console.log(
            `Rendering plot ${plot.MaThua}: MaVung=${plot.MaVung}, Region found:`,
            region ? region.TenVung : "Not found"
          );

          const row = `
                <tr data-mavung="${plot.MaVung}">
                  <td class="text-center font-weight-bold">${index + 1}</td>
                  <td class="font-weight-bold text-primary">TD${plot.MaThua.toString().padStart(
                    3,
                    "0"
                  )}</td>
                  <td>üó∫Ô∏è ${region ? region.TenVung : "Ch∆∞a x√°c ƒë·ªãnh"}</td>
                  <td>üë§ ${farmer ? farmer.HoTen : "Ch∆∞a c√≥ ch·ªß"}</td>
                  <td>
                    <span class="badge badge-secondary">${
                      plot.LoaiDat || "Ch∆∞a x√°c ƒë·ªãnh"
                    }</span>
                  </td>
                  <td class="text-center">
                    <span class="badge badge-info">${
                      plot.DienTich || 0
                    } ha</span>
                  </td>
                  <td><small class="text-muted">${
                    plot.ViTri || "Ch∆∞a c√≥ v·ªã tr√≠"
                  }</small></td>
                  <td class="text-center">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-warning" onclick="editPlot(${
                        plot.MaThua
                      })" title="Ch·ªânh s·ª≠a">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deletePlot(${
                        plot.MaThua
                      })" title="X√≥a">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
          tbody.append(row);
        });
      }

      function renderFarmersTable(farmers) {
        const tbody = $("#farmersTableBody");
        tbody.empty();

        if (farmers.length === 0) {
          tbody.html(`
                <tr>
                  <td colspan="8" class="text-center">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i><br>
                    <p class="text-muted">Ch∆∞a c√≥ n√¥ng h·ªô n√†o</p>
                  </td>
                </tr>
              `);
          return;
        }

        farmers.forEach((farmer, index) => {
          const region = allRegions.find((r) => r.MaVung == farmer.MaVung);
          const plotCount = allPlots.filter(
            (p) => p.MaHo == farmer.MaHo
          ).length;

          const row = `
                <tr>
                  <td class="text-center font-weight-bold">${index + 1}</td>
                  <td class="font-weight-bold text-primary">NH${farmer.MaHo.toString().padStart(
                    3,
                    "0"
                  )}</td>
                  <td>
                    <span class="font-weight-bold">üë§ ${
                      farmer.HoTen || "Ch∆∞a c√≥ t√™n"
                    }</span><br>
                    <small class="text-muted">${farmer.GioiTinh || ""}</small>
                  </td>
                  <td>üó∫Ô∏è ${region ? region.TenVung : "Ch∆∞a x√°c ƒë·ªãnh"}</td>
                  <td>üìû ${farmer.SoDienThoai || "Ch∆∞a c√≥ SƒêT"}</td>
                  <td><small class="text-muted">${
                    farmer.DiaChi || "Ch∆∞a c√≥ ƒë·ªãa ch·ªâ"
                  }</small></td>
                  <td class="text-center">
                    <span class="badge badge-info">${plotCount} th·ª≠a</span>
                  </td>
                  <td class="text-center">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-info" onclick="viewFarmerDetails(${
                        farmer.MaHo
                      })" title="Xem chi ti·∫øt">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-warning" onclick="editFarmer(${
                        farmer.MaHo
                      })" title="Ch·ªânh s·ª≠a">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
          tbody.append(row);
        });
      }

      function renderVarietiesTable(varieties) {
        const tbody = $("#varietiesTableBody");
        tbody.empty();

        if (varieties.length === 0) {
          tbody.html(`
                <tr>
                  <td colspan="7" class="text-center">
                    <i class="fas fa-seedling fa-3x text-muted mb-3"></i><br>
                    <p class="text-muted">Ch∆∞a c√≥ gi·ªëng cam n√†o</p>
                  </td>
                </tr>
              `);
          return;
        }

        varieties.forEach((variety, index) => {
          const row = `
                <tr>
                  <td class="text-center font-weight-bold">${index + 1}</td>
                  <td class="font-weight-bold text-primary">GC${variety.MaGiong.toString().padStart(
                    3,
                    "0"
                  )}</td>
                  <td>
                    <span class="font-weight-bold">üçä ${
                      variety.TenGiong || "Ch∆∞a c√≥ t√™n"
                    }</span>
                  </td>
                  <td><small class="text-muted">${
                    variety.DacTinh || "Ch∆∞a c√≥ th√¥ng tin"
                  }</small></td>
                  <td><small class="text-muted">${
                    variety.NguonGoc || "Ch∆∞a c√≥ th√¥ng tin"
                  }</small></td>
                  <td class="text-center">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-warning" onclick="editVariety(${
                        variety.MaGiong
                      })" title="Ch·ªânh s·ª≠a">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteVariety(${
                        variety.MaGiong
                      })" title="X√≥a">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
          tbody.append(row);
        });
      }

      // Th√™m event handlers cho filtering v√† searching
      $("#searchRegion, #filterRegionStatus").on("input change", function () {
        filterRegionsTable();
      });

      // Function ƒë·ªÉ l·ªçc b·∫£ng v√πng tr·ªìng
      function filterRegionsTable() {
        const searchText = $("#searchRegion").val().toLowerCase();
        const statusFilter = $("#filterRegionStatus").val();

        let filteredRegions = allRegions;

        // L·ªçc theo text search
        if (searchText) {
          filteredRegions = filteredRegions.filter((region) => {
            const searchableText = [
              region.TenVung,
              region.DiaChi,
              region.Xa,
              region.Huyen,
              region.Tinh,
              `VT${region.MaVung.toString().padStart(3, "0")}`,
            ]
              .join(" ")
              .toLowerCase();

            return searchableText.includes(searchText);
          });
        }

        // L·ªçc theo tr·∫°ng th√°i
        if (statusFilter !== "") {
          filteredRegions = filteredRegions.filter((region) => {
            return region.TrangThai == statusFilter;
          });
        }

        renderRegionsTable(filteredRegions);
      }

      // Th√™m event handlers cho tab switching
      $('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
        const targetTab = $(e.target).attr("href").substring(1);
        loadTabData(targetTab);
      });

      // Th√™m filtering cho c√°c tab kh√°c
      $("#searchPlot, #filterPlotRegion").on("input change", function () {
        filterPlotsTable();
      });

      $("#searchFarmer, #filterFarmerRegion").on("input change", function () {
        filterFarmersTable();
      });

      //$(" #filterCropSeason, #filterCropVariety").on("change", function () {
      //  filterCropsTable();
      //});
      $("#filterCropSeason").on("change", function () {
        let selectedValue = $(this).val();
        $("table tbody tr").each(function () {
          var maVu = $(this).data("ma-vu"); // L·∫•y thu·ªôc t√≠nh data-ma-vu c·ªßa h√†ng

          if (selectedValue === "" || maVu == selectedValue) {
            $(this).show(); // Hi·ªÉn th·ªã n·∫øu tr√πng
          } else {
            $(this).hide(); // ·∫®n n·∫øu kh√¥ng tr√πng
          }
        });
      });

      // Function ƒë·ªÉ l·ªçc b·∫£ng th·ª≠a ƒë·∫•t
      function filterPlotsTable() {
        const searchText = $("#searchPlot").val().toLowerCase();
        const regionFilter = $("#filterPlotRegion").val();

        let filteredPlots = allPlots;

        // L·ªçc theo text search
        if (searchText) {
          filteredPlots = filteredPlots.filter((plot) => {
            const region = allRegions.find((r) => r.MaVung == plot.MaVung);
            const farmer = allFarmers.find((f) => f.MaHo == plot.MaHo);

            const searchableText = [
              `TD${plot.MaThua.toString().padStart(3, "0")}`,
              region ? region.TenVung : "",
              farmer ? farmer.HoTen : "",
              plot.LoaiDat,
              plot.ViTri,
              plot.DienTich,
            ]
              .join(" ")
              .toLowerCase();

            return searchableText.includes(searchText);
          });
        }

        // L·ªçc theo v√πng tr·ªìng
        if (regionFilter) {
          filteredPlots = filteredPlots.filter(
            (plot) => plot.MaVung == regionFilter
          );
        }

        renderPlotsTable(filteredPlots);
      }

      // Function ƒë·ªÉ l·ªçc b·∫£ng n√¥ng h·ªô
      function filterFarmersTable() {
        const searchText = $("#searchFarmer").val().toLowerCase();
        const regionFilter = $("#filterFarmerRegion").val();

        let filteredFarmers = allFarmers;

        if (searchText) {
          filteredFarmers = filteredFarmers.filter((farmer) => {
            const region = allRegions.find((r) => r.MaVung == farmer.MaVung);

            const searchableText = [
              `NH${farmer.MaHo.toString().padStart(3, "0")}`,
              farmer.HoTen,
              farmer.SoDienThoai,
              farmer.DiaChi,
              region ? region.TenVung : "",
            ]
              .join(" ")
              .toLowerCase();

            return searchableText.includes(searchText);
          });
        }

        if (regionFilter) {
          filteredFarmers = filteredFarmers.filter(
            (farmer) => farmer.MaVung == regionFilter
          );
          console.log(
            `Filtered farmers by region ${regionFilter}:`,
            filteredFarmers
          );
        }

        renderFarmersTable(filteredFarmers);
      }

      // Function ƒë·ªÉ l·ªçc b·∫£ng c√¢y tr·ªìng
      function filterCropsTable() {
        const seasonFilter = $("#filterCropSeason").val();
        const varietyFilter = $("#filterCropVariety").val();
        //l·ªçc th√™ m√πa v·ª•
        let filteredSeasons = allSeasons;
        let filteredVarieties = allVarieties;
        if (seasonFilter) {
          filteredSeasons = filteredSeasons.filter(
            (season) => season.MaVu == seasonFilter
          );
          // Render b·∫£ng m√πa v·ª•
          renderVarietiesTable(filteredSeasons);
        }
        // l·ªçc theo gi·ªëng cam
        if (varietyFilter) {
          filteredVarieties = filteredVarieties.filter(
            (crop) => crop.MaGiong == varietyFilter
          );
          // Render b·∫£ng gi·ªëng cam
          renderVarietiesTable(filteredVarieties);
        }
      }

      // C·∫≠p nh·∫≠t function updateRegionStats ƒë·ªÉ t√≠nh to√°n ch√≠nh x√°c
      function updateRegionStats() {
        const total = allRegions.length;
        const totalArea = allRegions.reduce(
          (sum, region) => sum + parseFloat(region.DienTich || 0),
          0
        );
        const active = allRegions.filter(
          (region) => region.TrangThai == 1
        ).length;

        // Load farmers ƒë·ªÉ t√≠nh t·ªïng s·ªë n√¥ng h·ªô n·∫øu ch∆∞a c√≥
        if (allFarmers.length === 0) {
          $.ajax({
            url: "../../API/api_quan_ly_nong_ho.php",
            type: "GET",
            cache: false,
            xhrFields: { withCredentials: true },
            success: function (res) {
              if (res.status === "success") {
                allFarmers = res.data || [];
                $("#totalFarmers").text(allFarmers.length);
              }
            },
          });
        } else {
          $("#totalFarmers").text(allFarmers.length);
        }

        $("#totalRegions").text(total);
        $("#totalArea").text(totalArea.toFixed(1));
        $("#activeRegions").text(active);
      }

      // Populate dropdowns
      function populateRegionDropdowns() {
        const selectors = [
          "#plotRegion",
          "#farmerRegion",
          "#cropRegion",
          "#filterPlotRegion",
          "#filterFarmerRegion",
        ];

        selectors.forEach((selector) => {
          const $select = $(selector);
          const currentVal = $select.val();
          $select.empty();

          if (selector.includes("filter")) {
            $select.append('<option value="">T·∫•t c·∫£ v√πng tr·ªìng</option>');
          } else {
            $select.append('<option value="">Ch·ªçn v√πng tr·ªìng...</option>');
          }

          allRegions.forEach((region) => {
            let viTri = [region.DiaChi, region.Xa, region.Huyen, region.Tinh]
              .filter(Boolean)
              .join(", ");
            console.log(
              `Adding region option: MaVung=${region.MaVung}, Text=${region.DienTich}ha - ${viTri}`
            );
            $select.append(
              `<option value="${region.MaVung}">${region.DienTich}ha - ${viTri}</option>`
            );
          });

          if (currentVal) $select.val(currentVal);
        });

        // Also populate farmer dropdowns when regions are updated
        if (allFarmers.length > 0) {
          populateFarmerDropdowns();
        }
      }

      function populateSeasonDropdowns() {
        const selectors = ["#cropSeason", "#filterCropSeason"];

        selectors.forEach((selector) => {
          const $select = $(selector);
          const currentVal = $select.val();
          $select.empty();

          if (selector.includes("filter")) {
            $select.append('<option value="">T·∫•t c·∫£ v·ª• m√πa</option>');
          } else {
            $select.append('<option value="">Ch·ªçn v·ª• m√πa...</option>');
          }

          allSeasons.forEach((season) => {
            $select.append(
              `<option value="${season.MaVu}">${season.TenVu}</option>`
            );
          });

          if (currentVal) $select.val(currentVal);
        });
      }

      function populateVarietyDropdowns() {
        const selectors = ["#cropVariety", "#filterCropVariety"];

        selectors.forEach((selector) => {
          const $select = $(selector);
          const currentVal = $select.val();
          $select.empty();

          if (selector.includes("filter")) {
            $select.append('<option value="">T·∫•t c·∫£ gi·ªëng cam</option>');
          } else {
            $select.append('<option value="">Ch·ªçn gi·ªëng cam...</option>');
          }

          allVarieties.forEach((variety) => {
            $select.append(
              `<option value="${variety.MaGiong}">${variety.TenGiong}</option>`
            );
          });

          if (currentVal) $select.val(currentVal);
        });
      }

      // Event handlers
      $("#addRegionBtn").click(function () {
        $("#regionModalTitle").text("Th√™m v√πng tr·ªìng m·ªõi");
        $("#regionForm")[0].reset();
        $("#regionId").val("");
        $("#regionModal").modal("show");
      });

      $("#saveRegionBtn").click(function () {
        saveRegion();
      });

      // Th√™m event handler cho n√∫t l∆∞u m√πa v·ª•
      $("#saveSeasonBtn").click(function () {
        saveSeason();
      });

      function saveRegion() {
        // Validate form
        if (!$("#regionForm")[0].checkValidity()) {
          $("#regionForm")[0].reportValidity();
          return;
        }

        const regionData = {
          MaVung: $("#regionId").val(),
          TenVung: $("#regionName").val(),
          DiaChi: $("#regionAddress").val(),
          Tinh: $("#regionProvince").val(),
          Huyen: $("#regionDistrict").val(),
          Xa: $("#regionWard").val(),
          DienTich: $("#regionArea").val(),
          SoHoDan: $("#regionHouseholds").val() || 0,
          TrangThai: $("#regionStatus").val(),
          MoTa: $("#regionDescription").val(),
        };

        const isEdit = regionData.MaVung !== "";
        const url = "../../API/api_quan_ly_vung_trong.php";
        const method = isEdit ? "PUT" : "POST";

        $.ajax({
          url: url,
          type: method,
          data: JSON.stringify(regionData),
          contentType: "application/json",
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              $("#regionModal").modal("hide");
              Swal.fire("Th√†nh c√¥ng!", res.message, "success");
              loadRegions();
            } else {
              Swal.fire("L·ªói!", res.message, "error");
            }
          },
          error: function (xhr, status, error) {
            console.error("Error saving region:", error);
            Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu", "error");
          },
        });
      }

      function editRegion(maVung) {
        const region = allRegions.find((r) => r.MaVung == maVung);
        if (!region) return;

        $("#regionModalTitle").text("Ch·ªânh s·ª≠a v√πng tr·ªìng");
        $("#regionId").val(region.MaVung);
        $("#regionName").val(region.TenVung);
        $("#regionAddress").val(region.DiaChi);
        $("#regionProvince").val(region.Tinh);
        $("#regionDistrict").val(region.Huyen);
        $("#regionWard").val(region.Xa);
        $("#regionArea").val(region.DienTich);
        $("#regionHouseholds").val(region.SoHoDan);
        $("#regionStatus").val(region.TrangThai);
        $("#regionDescription").val(region.MoTa);
        $("#regionModal").modal("show");
      }

      function deleteRegion(maVung) {
        Swal.fire({
          title: "X√°c nh·∫≠n x√≥a",
          text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a v√πng tr·ªìng n√†y?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "X√≥a",
          cancelButtonText: "H·ªßy",
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: "../../API/api_quan_ly_vung_trong.php",
              type: "DELETE",
              data: JSON.stringify({ MaVung: maVung }),
              contentType: "application/json",
              xhrFields: { withCredentials: true },
              success: function (res) {
                if (res.status === "success") {
                  Swal.fire("ƒê√£ x√≥a!", res.message, "success");
                  loadRegions();
                } else {
                  Swal.fire("L·ªói!", res.message, "error");
                }
              },
              error: function (xhr, status, error) {
                console.error("Error deleting region:", error);
                Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu", "error");
              },
            });
          }
        });
      }

      function viewRegionDetails(maVung) {
        const region = allRegions.find((r) => r.MaVung == maVung);
        if (!region) {
          Swal.fire("L·ªói!", "Kh√¥ng t√¨m th·∫•y th√¥ng tin v√πng tr·ªìng", "error");
          return;
        }

        // T√≠nh to√°n th·ªëng k√™
        const regionFarmers = allFarmers.filter((f) => f.MaVung == maVung);
        const regionPlots = allPlots.filter((p) => p.MaVung == maVung);
        const totalPlotArea = regionPlots.reduce(
          (sum, plot) => sum + parseFloat(plot.DienTich || 0),
          0
        );

        // Th√¥ng tin ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß
        const fullAddress = [
          region.DiaChi,
          region.Xa,
          region.Huyen,
          region.Tinh,
        ]
          .filter(Boolean)
          .join(", ");

        // Hi·ªÉn th·ªã status
        const statusBadge =
          region.TrangThai == 1
            ? '<span class="badge badge-success badge-lg">Ho·∫°t ƒë·ªông</span>'
            : '<span class="badge badge-secondary badge-lg">Kh√¥ng ho·∫°t ƒë·ªông</span>';

        // T·∫°o danh s√°ch n√¥ng h·ªô
        let farmersHtml = "";
        if (regionFarmers.length > 0) {
          farmersHtml = `
            <h6 class="mt-4 mb-3">Danh s√°ch n√¥ng h·ªô (${regionFarmers.length} h·ªô):</h6>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="thead-light">
                  <tr>
                    <th>M√£ n√¥ng h·ªô</th>
                    <th>H·ªç t√™n</th>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <th>S·ªë th·ª≠a ƒë·∫•t</th>
                    <th>Di·ªán t√≠ch (km)</th>
                  </tr>
                </thead>
                <tbody>
          `;

          regionFarmers.forEach((farmer) => {
            const farmerPlots = allPlots.filter((p) => p.MaHo == farmer.MaHo);
            const farmerTotalArea = farmerPlots.reduce(
              (sum, plot) => sum + parseFloat(plot.DienTich || 0),
              0
            );

            farmersHtml += `
              <tr>
                <td>NH${farmer.MaHo.toString().padStart(3, "0")}</td>
                <td>${farmer.HoTen || "Ch∆∞a c√≥ t√™n"}</td>
                <td>${farmer.SoDienThoai || "Ch∆∞a c√≥ SƒêT"}</td>
                <td class="text-center">${farmerPlots.length}</td>
                <td class="text-center">${farmerTotalArea.toFixed(2)}</td>
              </tr>
            `;
          });

          farmersHtml += `
                </tbody>
              </table>
            </div>
          `;
        } else {
          farmersHtml =
            '<p class="text-muted mt-4">V√πng tr·ªìng n√†y ch∆∞a c√≥ n√¥ng h·ªô n√†o.</p>';
        }

        // T·∫°o danh s√°ch th·ª≠a ƒë·∫•t
        let plotsHtml = "";
        if (regionPlots.length > 0) {
          plotsHtml = `
            <h6 class="mt-4 mb-3">Danh s√°ch th·ª≠a ƒë·∫•t (${regionPlots.length} th·ª≠a):</h6>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="thead-light">
                  <tr>
                    <th>M√£ th·ª≠a</th>
                    <th>Ch·ªß th·ª≠a</th>
                    <th>Lo·∫°i ƒë·∫•t</th>
                    <th>Di·ªán t√≠ch (km)</th>
                    <th>V·ªã tr√≠</th>
                  </tr>
                </thead>
                <tbody>
          `;

          regionPlots.forEach((plot) => {
            const farmer = allFarmers.find((f) => f.MaHo == plot.MaHo);

            plotsHtml += `
              <tr>
                <td>TD${plot.MaThua.toString().padStart(3, "0")}</td>
                <td>${farmer ? farmer.HoTen : "Ch∆∞a c√≥ ch·ªß"}</td>
                <td>${plot.LoaiDat || "Ch∆∞a x√°c ƒë·ªãnh"}</td>
                <td class="text-center">${plot.DienTich || 0}</td>
                <td>${plot.ViTri || "Ch∆∞a c√≥ th√¥ng tin"}</td>
              </tr>
            `;
          });

          plotsHtml += `
                </tbody>
              </table>
            </div>
          `;
        } else {
          plotsHtml =
            '<p class="text-muted mt-4">V√πng tr·ªìng n√†y ch∆∞a c√≥ th·ª≠a ƒë·∫•t n√†o.</p>';
        }

        const regionDetailContent = `
          <div class="row">
            <div class="col-md-6">
              <h6>Th√¥ng tin c∆° b·∫£n:</h6>
              <table class="table table-borderless table-sm">
                <tr><td class="font-weight-bold">M√£ v√πng tr·ªìng:</td><td>VT${region.MaVung.toString().padStart(
                  3,
                  "0"
                )}</td></tr>
                <tr><td class="font-weight-bold">T√™n v√πng tr·ªìng:</td><td>${
                  region.TenVung || "Ch∆∞a c√≥ t√™n"
                }</td></tr>
                <tr><td class="font-weight-bold">Tr·∫°ng th√°i:</td><td>${statusBadge}</td></tr>
                <tr><td class="font-weight-bold">Di·ªán t√≠ch quy ho·∫°ch:</td><td>${
                  region.DienTich || 0
                } ha</td></tr>
                <tr><td class="font-weight-bold">S·ªë h·ªô d√¢n:</td><td>${
                  region.SoHoDan || 0
                } h·ªô</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6>Th√¥ng tin ƒë·ªãa l√Ω:</h6>
              <table class="table table-borderless table-sm">
                <tr><td class="font-weight-bold">ƒê·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß:</td><td>${
                  fullAddress || "Ch∆∞a c√≥ ƒë·ªãa ch·ªâ"
                }</td></tr>
                <tr><td class="font-weight-bold">T·ªânh/Th√†nh ph·ªë:</td><td>${
                  region.Tinh || "Ch∆∞a x√°c ƒë·ªãnh"
                }</td></tr>
                <tr><td class="font-weight-bold">Qu·∫≠n/Huy·ªán:</td><td>${
                  region.Huyen || "Ch∆∞a x√°c ƒë·ªãnh"
                }</td></tr>
                <tr><td class="font-weight-bold">Ph∆∞·ªùng/X√£:</td><td>${
                  region.Xa || "Ch∆∞a x√°c ƒë·ªãnh"
                }</td></tr>
                <tr><td class="font-weight-bold">M√¥ t·∫£:</td><td>${
                  region.MoTa || "Ch∆∞a c√≥ m√¥ t·∫£"
                }</td></tr>
              </table>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-12">
              <div class="row">
                <div class="col-md-3">
                  <div class="card border-primary region-stats-card">
                    <div class="card-body text-center">
                      <h4 class="text-primary">${regionFarmers.length}</h4>
                      <small class="text-muted">S·ªë n√¥ng h·ªô</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-success region-stats-card">
                    <div class="card-body text-center">
                      <h4 class="text-success">${regionPlots.length}</h4>
                      <small class="text-muted">S·ªë th·ª≠a ƒë·∫•t</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-info region-stats-card">
                    <div class="card-body text-center">
                      <h4 class="text-info">${totalPlotArea.toFixed(1)}</h4>
                      <small class="text-muted">Di·ªán t√≠ch th·ª±c t·∫ø (km)</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card border-warning region-stats-card">
                    <div class="card-body text-center">
                      <h4 class="text-warning">${
                        region.DienTich
                          ? (
                              (totalPlotArea / parseFloat(region.DienTich)) *
                              100
                            ).toFixed(1)
                          : "0"
                      }%</h4>
                      <small class="text-muted">T·ª∑ l·ªá s·ª≠ d·ª•ng</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          ${farmersHtml}
          ${plotsHtml}
        `;

        $("#regionDetailModalTitle").text(
          `Chi ti·∫øt v√πng tr·ªìng - ${region.TenVung}`
        );
        $("#regionDetailContent").html(regionDetailContent);
        $("#regionDetailModal").modal("show");
      }

      // Th√™m c√°c event handlers cho th·ª≠a ƒë·∫•t
      $("#addPlotBtn").click(function () {
        $("#plotModalTitle").text("Th√™m th·ª≠a ƒë·∫•t m·ªõi");
        $("#plotForm")[0].reset();
        $("#plotId").val("");

        // T·∫°o l·∫°i dropdown v√πng tr·ªìng n·∫øu ƒë√£ b·ªã x√≥a
        if ($("#plotRegion").length === 0) {
          const regionFormGroup = `
            <div class="form-group">
              <label for="plotRegion">V√πng tr·ªìng *</label>
              <select class="form-control" id="plotRegion" required>
                <option value="">Ch·ªçn v√πng tr·ªìng...</option>
              </select>
            </div>
          `;
          $("#plotFarmer")
            .closest(".form-group")
            .parent()
            .prepend(`<div class="col-md-6">${regionFormGroup}</div>`);
          // Populate l·∫°i dropdown sau khi t·∫°o
          populateRegionDropdowns();
        }

        populatePlotFarmersDropdown(); // Load danh s√°ch n√¥ng h·ªô
        $("#plotModal").modal("show");
      });

      $("#savePlotBtn").click(function () {
        savePlot();
      });

      // Function ƒë·ªÉ populate dropdown n√¥ng h·ªô trong plot modal
      function populatePlotFarmersDropdown() {
        const $select = $("#plotFarmer");
        $select.empty();
        $select.append('<option value="">Ch·ªçn n√¥ng h·ªô...</option>');

        allFarmers.forEach((farmer) => {
          const region = allRegions.find((r) => r.MaVung == farmer.MaVung);
          const regionName = region ? region.TenVung : "Ch∆∞a x√°c ƒë·ªãnh";
          $select.append(
            `<option value="${farmer.MaHo}">${farmer.HoTen} - ${regionName}</option>`
          );
        });
      }

      // Function ƒë·ªÉ l∆∞u th·ª≠a ƒë·∫•t
      function savePlot() {
        // Validate form
        if (!$("#plotForm")[0].checkValidity()) {
          $("#plotForm")[0].reportValidity();
          return;
        }

        const isEdit = $("#plotId").val() !== "";

        // T·∫°o plotData kh√°c nhau cho th√™m m·ªõi v√† ch·ªânh s·ª≠a
        let plotData;

        if (isEdit) {
          // Khi ch·ªânh s·ª≠a: kh√¥ng c·∫≠p nh·∫≠t v√πng tr·ªìng
          plotData = {
            MaThua: $("#plotId").val(),
            MaHo: $("#plotFarmer").val(),
            DienTich: $("#plotArea").val(),
            LoaiDat: $("#plotType").val(),
            ViTri: $("#plotLocation").val(),
          };
        } else {
          // Khi th√™m m·ªõi: bao g·ªìm v√πng tr·ªìng
          plotData = {
            MaThua: $("#plotId").val(),
            MaVung: $("#plotRegion").val(),
            MaHo: $("#plotFarmer").val(),
            DienTich: $("#plotArea").val(),
            LoaiDat: $("#plotType").val(),
            ViTri: $("#plotLocation").val(),
          };
        }

        const url = "../../API/api_quan_ly_thua_dat.php";
        const method = isEdit ? "PUT" : "POST";

        $.ajax({
          url: url,
          type: method,
          data: JSON.stringify(plotData),
          contentType: "application/json",
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              $("#plotModal").modal("hide");
              Swal.fire("Th√†nh c√¥ng!", res.message, "success");
              loadPlots(); // Reload d·ªØ li·ªáu th·ª≠a ƒë·∫•t
              updateRegionStats(); // C·∫≠p nh·∫≠t th·ªëng k√™
            } else {
              Swal.fire("L·ªói!", res.message, "error");
            }
          },
          error: function (xhr, status, error) {
            console.error("Error saving plot:", error);
            Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu", "error");
          },
        });
      }

      // Function ƒë·ªÉ edit th·ª≠a ƒë·∫•t
      function editPlot(maThua) {
        const plot = allPlots.find((p) => p.MaThua == maThua);
        if (!plot) return;

        $("#plotModalTitle").text("Ch·ªânh s·ª≠a th·ª≠a ƒë·∫•t");
        $("#plotId").val(plot.MaThua);
        $("#plotFarmer").val(plot.MaHo);
        $("#plotArea").val(plot.DienTich);
        $("#plotType").val(plot.LoaiDat);
        $("#plotLocation").val(plot.ViTri);

        // X√≥a ho√†n to√†n dropdown v√πng tr·ªìng khi ch·ªânh s·ª≠a
        $("#plotRegion").closest(".form-group").parent().remove();

        populatePlotFarmersDropdown(); // Load l·∫°i dropdown n√¥ng h·ªô
        $("#plotFarmer").val(plot.MaHo); // Set l·∫°i gi√° tr·ªã sau khi populate

        $("#plotModal").modal("show");
      }

      // Function ƒë·ªÉ x√≥a th·ª≠a ƒë·∫•t
      function deletePlot(maThua) {
        Swal.fire({
          title: "X√°c nh·∫≠n x√≥a",
          text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th·ª≠a ƒë·∫•t n√†y?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "X√≥a",
          cancelButtonText: "H·ªßy",
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: "../../API/api_quan_ly_thua_dat.php",

              type: "DELETE",
              data: JSON.stringify({ MaThua: maThua }),
              contentType: "application/json",
              xhrFields: { withCredentials: true },
              success: function (res) {
                if (res.status === "success") {
                  Swal.fire("ƒê√£ x√≥a!", res.message, "success");
                  loadPlots();
                } else {
                  Swal.fire("L·ªói!", res.message, "error");
                }
              },
              error: function (xhr, status, error) {
                console.error("Error deleting plot:", error);
                Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu", "error");
              },
            });
          }
        });
      }

      // S·ª≠a event handler cho addCropBtn
      $("#addCropBtn").click(function () {
        // Ki·ªÉm tra ƒëang ·ªü sub-tab n√†o
        const activeSubTab = $("#cropSubTabs .nav-link.active").attr("href");

        if (activeSubTab === "#varieties-content") {
          // N·∫øu ƒëang ·ªü tab Gi·ªëng cam - m·ªü modal th√™m gi·ªëng cam
          $("#varietyModalTitle").text("Th√™m gi·ªëng cam m·ªõi");
          $("#varietyForm")[0].reset();
          $("#varietyId").val("");
          $("#varietyModal").modal("show");
        } else {
          // N·∫øu ƒëang ·ªü tab M√πa v·ª• - m·ªü modal th√™m m√πa v·ª•
          $("#seasonModalTitle").text("Th√™m m√πa v·ª• m·ªõi");
          $("#seasonForm")[0].reset();
          $("#seasonId").val("");
          $("#seasonModal").modal("show");
        }
      });

      // Th√™m event handler cho sub-tab switching
      $('#cropSubTabs a[data-toggle="pill"]').on("shown.bs.pill", function (e) {
        const targetSubTab = $(e.target).attr("href");

        // Thay ƒë·ªïi text button t√πy theo sub-tab
        if (targetSubTab === "#varieties-content") {
          $("#addCropBtn").html(
            '<i class="fas fa-seedling"></i> Th√™m gi·ªëng cam'
          );
          loadVarieties(); // Load d·ªØ li·ªáu gi·ªëng cam
        } else if (targetSubTab === "#seasons-content") {
          $("#addCropBtn").html(
            '<i class="fas fa-calendar-plus"></i> Th√™m m√πa v·ª•'
          );
          loadSeasons(); // Load d·ªØ li·ªáu m√πa v·ª•
        }
      });

      // Th√™m event handler ƒë·ªÉ load d·ªØ li·ªáu khi click v√†o sub-tab "Gi·ªëng cam"
      $("#varieties-subtab").on("shown.bs.tab", function (e) {
        console.log("Loading varieties...");
        loadVarieties();
      });

      // Function ƒë·ªÉ load d·ªØ li·ªáu m√πa v·ª•
      function loadSeasons() {
        $("#seasonsTableBody").html(`
        <tr>
          <td colspan="6" class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">ƒêang t·∫£i...</span>
            </div>
            <p class="mt-2">ƒêang t·∫£i danh s√°ch m√πa v·ª•...</p>
          </td>
        </tr>
      `);

        $.ajax({
          url: "../../API/api_quan_ly_vu_mua.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              allSeasons = res.data || [];
              console.log("Loaded seasons:", allSeasons);
              renderSeasonsTable(allSeasons);
            }
          },
          error: function (xhr, status, error) {
            console.error("Error loading seasons:", error);
            $("#seasonsTableBody").html(`
            <tr>
              <td colspan="6" class="text-center text-danger">
                C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu m√πa v·ª•
              </td>
            </tr>
          `);
          },
        });
      }

      // Function ƒë·ªÉ render b·∫£ng m√πa v·ª•
      function renderSeasonsTable(seasons) {
        const tbody = $("#seasonsTableBody");
        tbody.empty();

        if (seasons.length === 0) {
          tbody.html(`
          <tr>
            <td colspan="6" class="text-center">
              <i class="fas fa-calendar fa-3x text-muted mb-3"></i><br>
              <p class="text-muted">Ch∆∞a c√≥ m√πa v·ª• n√†o</p>
            </td>
          </tr>
        `);
          return;
        }

        seasons.forEach((season, index) => {
          const row = `
          <tr data-ma-vu="${season.MaVu}">
            <td class="text-center font-weight-bold">${index + 1}</td>
            <td class="font-weight-bold text-primary">MV${season.MaVu.toString().padStart(
              3,
              "0"
            )}</td>
            <td>
              <span class="font-weight-bold">üìÖ ${
                season.TenVu || "Ch∆∞a c√≥ t√™n"
              }</span>
            </td>
            <td class="text-center">${
              season.ThoiGianBatDau || "Ch∆∞a x√°c ƒë·ªãnh"
            }</td>
            <td class="text-center">${
              season.ThoiGianThuHoach || "Ch∆∞a t·ªõi ƒë·ª£t thu ho·∫°ch"
            }</td>
            <td class="text-center">
              <div class="btn-group">
                <button class="btn btn-sm btn-warning" onclick="editSeason(${
                  season.MaVu
                })" title="Ch·ªânh s·ª≠a">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteSeason(${
                  season.MaVu
                })" title="X√≥a">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
          tbody.append(row);
        });
      }

      // Gi·ªØ nguy√™n c√°c function cho gi·ªëng cam nh∆∞ ƒë√£ c√≥:
      // - saveVariety()
      // - editVariety()
      // - deleteVariety()
      // - loadVarieties()
      // - renderVarietiesTable()

      // Th√™m c√°c function CRUD cho gi·ªëng cam
      function saveVariety() {
        // Validate form
        if (!$("#varietyForm")[0].checkValidity()) {
          $("#varietyForm")[0].reportValidity();
          return;
        }

        const varietyData = {
          MaGiong: $("#varietyId").val(),
          TenGiong: $("#varietyName").val(),
          DacTinh: $("#varietyCharacteristics").val(),
          NguonGoc: $("#varietyOrigin").val(),
        };

        const isEdit = varietyData.MaGiong !== "";
        const url = "../../API/api_quan_ly_cay_trong.php";
        const method = isEdit ? "PUT" : "POST";

        $.ajax({
          url: url,
          type: method,
          data: JSON.stringify(varietyData),
          contentType: "application/json",
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              $("#varietyModal").modal("hide");
              Swal.fire("Th√†nh c√¥ng!", res.message, "success");
              loadVarieties();
              populateVarietyDropdowns();
            } else {
              Swal.fire("L·ªói!", res.message, "error");
            }
          },
          error: function (xhr, status, error) {
            console.error("Error saving variety:", error);
            Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu", "error");
          },
        });
      }

      // S·ª≠a event handler cho n√∫t l∆∞u gi·ªëng cam
      $("#saveVarietyBtn").click(function () {
        saveVariety();
      });

      // Th√™m c√°c function cho m√πa v·ª• (t∆∞∆°ng t·ª± nh∆∞ gi·ªëng cam)
      function saveSeason() {
        // Validate form
        if (!$("#seasonForm")[0].checkValidity()) {
          $("#seasonForm")[0].reportValidity();
          return;
        }

        const seasonData = {
          MaVu: $("#seasonId").val(),
          TenVu: $("#seasonName").val(),
          NgayBatDau: $("#seasonStartDate").val(),
          NgayKetThuc: $("#seasonEndDate").val(),
          MoTa: $("#seasonDescription").val(),
        };

        const isEdit = seasonData.MaVu !== "";
        const url = "../../API/api_quan_ly_vu_mua.php";
        const method = isEdit ? "PUT" : "POST";

        $.ajax({
          url: url,
          type: method,
          data: JSON.stringify(seasonData),
          contentType: "application/json",
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              $("#seasonModal").modal("hide");
              Swal.fire("Th√†nh c√¥ng!", res.message, "success");
              loadSeasons();
              populateSeasonDropdowns();
            } else {
              Swal.fire("L·ªói!", res.message, "error");
            }
          },
          error: function (xhr, status, error) {
            console.error("Error saving season:", error);
            Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu", "error");
          },
        });
      }

      // Function ƒë·ªÉ ch·ªânh s·ª≠a m√πa v·ª•
      function editSeason(maVu) {
        const season = allSeasons.find((s) => s.MaVu == maVu);
        if (!season) return;

        $("#seasonModalTitle").text("Ch·ªânh s·ª≠a m√πa v·ª•");
        $("#seasonId").val(season.MaVu);
        $("#seasonName").val(season.TenVu);
        $("#seasonStartDate").val(season.ThoiGianBatDau);
        $("#seasonEndDate").val(season.ThoiGianThuHoach);
        $("#seasonDescription").val(season.MoTaVu);
        $("#seasonModal").modal("show");
      }

      // Function ƒë·ªÉ x√≥a m√πa v·ª•
      function deleteSeason(maVu) {
        Swal.fire({
          title: "X√°c nh·∫≠n x√≥a",
          text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√πa v·ª• n√†y?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "X√≥a",
          cancelButtonText: "H·ªßy",
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: "../../API/api_quan_ly_vu_mua.php",
              type: "DELETE",
              data: JSON.stringify({ MaVu: maVu }),
              contentType: "application/json",
              xhrFields: { withCredentials: true },
              success: function (res) {
                if (res.status === "success") {
                  Swal.fire("ƒê√£ x√≥a!", res.message, "success");
                  loadSeasons();
                  populateSeasonDropdowns();
                } else {
                  Swal.fire("L·ªói!", res.message, "error");
                }
              },
              error: function (xhr, status, error) {
                console.error("Error deleting season:", error);
                Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu", "error");
              },
            });
          }
        });
      }

      function editVariety(maGiong) {
        const variety = allVarieties.find((v) => v.MaGiong == maGiong);
        if (!variety) return;

        $("#varietyModalTitle").text("Ch·ªânh s·ª≠a gi·ªëng cam");
        $("#varietyId").val(variety.MaGiong);
        $("#varietyName").val(variety.TenGiong);
        $("#varietyCharacteristics").val(variety.DacTinh);
        $("#varietyOrigin").val(variety.NguonGoc);
        $("#varietyModal").modal("show");
      }

      // Function ƒë·ªÉ x√≥a gi·ªëng cam
      function deleteVariety(maGiong) {
        Swal.fire({
          title: "X√°c nh·∫≠n x√≥a",
          text: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a gi·ªëng cam n√†y?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "X√≥a",
          cancelButtonText: "H·ªßy",
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: "../../API/api_quan_ly_cay_trong.php",
              type: "DELETE",
              data: JSON.stringify({ MaGiong: maGiong }),
              contentType: "application/json",
              xhrFields: { withCredentials: true },
              success: function (res) {
                if (res.status === "success") {
                  Swal.fire("ƒê√£ x√≥a!", res.message, "success");
                  loadVarieties(); // Reload danh s√°ch gi·ªëng cam
                  populateVarietyDropdowns(); // C·∫≠p nh·∫≠t dropdowns
                } else {
                  Swal.fire("L·ªói!", res.message, "error");
                }
              },
              error: function (xhr, status, error) {
                console.error("Error deleting variety:", error);
                Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra khi x√≥a d·ªØ li·ªáu", "error");
              },
            });
          }
        });
      }

      // Function ƒë·ªÉ load danh s√°ch gi·ªëng cam
      function loadVarieties() {
        $("#varietiesTableBody").html(`
        <tr>
          <td colspan="7" class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">ƒêang t·∫£i...</span>
            </div>
            <p class="mt-2">ƒêang t·∫£i danh s√°ch gi·ªëng cam...</p>
          </td>
        </tr>
      `);

        $.ajax({
          url: "../../API/api_quan_ly_cay_trong.php",
          type: "GET",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            console.log("API Response:", res); // Debug log
            if (res.status === "success") {
              allVarieties = res.data || [];
              console.log("Varieties loaded:", allVarieties); // Debug log
              renderVarietiesTable(allVarieties);
              populateVarietyDropdowns();
            } else {
              console.error("API Error:", res.message); // Debug log
              $("#varietiesTableBody").html(`
              <tr>
                <td colspan="7" class="text-center text-danger">
                  L·ªói: ${res.message}
                </td>
              </tr>
            `);
            }
          },
          error: function (xhr, status, error) {
            console.error("AJAX Error:", error, xhr.responseText); // Debug log
            $("#varietiesTableBody").html(`
            <tr>
              <td colspan="7" class="text-center text-danger">
                C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu gi·ªëng cam
              </td>
            </tr>
          `);
          },
        });
      }

      // ==== FARMER VIEW OPERATIONS ====

      // Ch·ªâ gi·ªØ l·∫°i t√≠nh nƒÉng xem chi ti·∫øt v√† ch·ªânh s·ª≠a n√¥ng h·ªô

      // Function ƒë·ªÉ ch·ªânh s·ª≠a n√¥ng h·ªô
      function editFarmer(maHo) {
        const farmer = allFarmers.find((f) => f.MaHo == maHo);
        if (!farmer) {
          Swal.fire("L·ªói!", "Kh√¥ng t√¨m th·∫•y th√¥ng tin n√¥ng h·ªô", "error");
          return;
        }

        $("#editFarmerModalTitle").text("Ch·ªânh s·ª≠a th√¥ng tin n√¥ng h·ªô");
        $("#editFarmerId").val(farmer.MaHo);
        $("#editFarmerName").val(farmer.HoTen);
        $("#editFarmerGender").val(farmer.GioiTinh);
        $("#editFarmerPhone").val(farmer.SoDienThoai);
        $("#editFarmerEmail").val(farmer.Email);
        $("#editFarmerBirthdate").val(farmer.NgaySinh);
        $("#editFarmerAddress").val(farmer.DiaChi);

        // Populate region dropdown v√† set gi√° tr·ªã
        populateEditFarmerRegionDropdown();
        $("#editFarmerRegion").val(farmer.MaVung);

        $("#editFarmerModal").modal("show");
      }

      // Function ƒë·ªÉ populate dropdown v√πng tr·ªìng cho edit farmer modal
      function populateEditFarmerRegionDropdown() {
        const $select = $("#editFarmerRegion");
        $select.empty();
        $select.append('<option value="">Ch·ªçn v√πng tr·ªìng...</option>');

        allRegions.forEach((region) => {
          let viTri = [region.DiaChi, region.Xa, region.Huyen, region.Tinh]
            .filter(Boolean)
            .join(", ");
          $select.append(
            `<option value="${region.MaVung}">${region.TenVung} - ${viTri}</option>`
          );
        });
      }

      // Function ƒë·ªÉ l∆∞u thay ƒë·ªïi n√¥ng h·ªô
      function saveEditFarmer() {
        // Validate form
        if (!$("#editFarmerForm")[0].checkValidity()) {
          $("#editFarmerForm")[0].reportValidity();
          return;
        }

        const farmerData = {
          MaHo: $("#editFarmerId").val(),
          HoTen: $("#editFarmerName").val(),
          GioiTinh: $("#editFarmerGender").val(),
          SoDienThoai: $("#editFarmerPhone").val(),
          Email: $("#editFarmerEmail").val(),
          NgaySinh: $("#editFarmerBirthdate").val(),
          DiaChi: $("#editFarmerAddress").val(),
          MaVung: $("#editFarmerRegion").val(),
        };

        // Show loading
        Swal.fire({
          title: "ƒêang c·∫≠p nh·∫≠t...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        $.ajax({
          url: "../../API/api_quan_ly_nong_ho.php",
          type: "PUT",
          data: JSON.stringify(farmerData),
          contentType: "application/json",
          cache: false,
          xhrFields: { withCredentials: true },
          success: function (res) {
            if (res.status === "success") {
              $("#editFarmerModal").modal("hide");
              Swal.fire("Th√†nh c√¥ng!", res.message, "success");
              loadFarmers(); // Reload data
              loadFarmersForDropdown(); // Reload dropdown data
            } else {
              Swal.fire("L·ªói!", res.message || "C√≥ l·ªói x·∫£y ra", "error");
            }
          },
          error: function (xhr, status, error) {
            console.error("Error saving farmer:", error);
            if (xhr.status === 401) {
              Swal.fire(
                "L·ªói!",
                "Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.",
                "error"
              );
            } else {
              console.log("L·ªói: ", xhr.responseText);
              console.log("Status: ", status);
              console.log("Error: ", error);
              Swal.fire(
                "L·ªói!",
                "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin n√¥ng h·ªô",
                "error"
              );
            }
          },
        });
      }

      // Event handler cho button save edit farmer
      $("#saveEditFarmerBtn").click(function () {
        saveEditFarmer();
      });

      // Function ƒë·ªÉ xem chi ti·∫øt n√¥ng h·ªô
      function viewFarmerDetails(maHo) {
        const farmer = allFarmers.find((f) => f.MaHo == maHo);
        if (!farmer) {
          Swal.fire("L·ªói!", "Kh√¥ng t√¨m th·∫•y th√¥ng tin n√¥ng h·ªô", "error");
          return;
        }

        const region = allRegions.find((r) => r.MaVung == farmer.MaVung);
        const farmerPlots = allPlots.filter((p) => p.MaHo == maHo);
        const totalArea = farmerPlots.reduce(
          (sum, plot) => sum + parseFloat(plot.DienTich || 0),
          0
        );

        let plotsHtml = "";
        if (farmerPlots.length > 0) {
          plotsHtml = `
            <h6 class="mt-3 mb-2">Danh s√°ch th·ª≠a ƒë·∫•t (${farmerPlots.length} th·ª≠a):</h6>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="thead-light">
                  <tr>
                    <th>M√£ th·ª≠a</th>
                    <th>Di·ªán t√≠ch</th>
                    <th>Lo·∫°i ƒë·∫•t</th>
                    <th>V·ªã tr√≠</th>
                  </tr>
                </thead>
                <tbody>
          `;

          farmerPlots.forEach((plot) => {
            plotsHtml += `
              <tr>
                <td>TD${plot.MaThua.toString().padStart(3, "0")}</td>
                <td>${plot.DienTich || 0} km</td>
                <td>${plot.LoaiDat || "Ch∆∞a x√°c ƒë·ªãnh"}</td>
                <td>${plot.ViTri || "Ch∆∞a c√≥ th√¥ng tin"}</td>
              </tr>
            `;
          });

          plotsHtml += `
                </tbody>
              </table>
            </div>
          `;
        } else {
          plotsHtml =
            '<p class="text-muted mt-3">N√¥ng h·ªô n√†y ch∆∞a c√≥ th·ª≠a ƒë·∫•t n√†o.</p>';
        }

        const farmerDetailContent = `
          <div class="row">
            <div class="col-md-6">
              <h6>Th√¥ng tin c√° nh√¢n:</h6>
              <table class="table table-borderless table-sm">
                <tr><td class="font-weight-bold">M√£ n√¥ng h·ªô:</td><td>NH${farmer.MaHo.toString().padStart(
                  3,
                  "0"
                )}</td></tr>
                <tr><td class="font-weight-bold">H·ªç t√™n:</td><td>${
                  farmer.HoTen || "Ch∆∞a c√≥"
                }</td></tr>
                <tr><td class="font-weight-bold">Gi·ªõi t√≠nh:</td><td>${
                  farmer.GioiTinh || "Ch∆∞a c√≥"
                }</td></tr>
                <tr><td class="font-weight-bold">Ng√†y sinh:</td><td>${
                  farmer.NgaySinh || "Ch∆∞a c√≥"
                }</td></tr>
                <tr><td class="font-weight-bold">S·ªë ƒëi·ªán tho·∫°i:</td><td>${
                  farmer.SoDienThoai || "Ch∆∞a c√≥"
                }</td></tr>
                <tr><td class="font-weight-bold">Email:</td><td>${
                  farmer.Email || "Ch∆∞a c√≥"
                }</td></tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6>Th√¥ng tin s·∫£n xu·∫•t:</h6>
              <table class="table table-borderless table-sm">
                <tr><td class="font-weight-bold">V√πng tr·ªìng:</td><td>${
                  region ? region.TenVung : "Ch∆∞a x√°c ƒë·ªãnh"
                }</td></tr>
                <tr><td class="font-weight-bold">ƒê·ªãa ch·ªâ:</td><td>${
                  farmer.DiaChi || "Ch∆∞a c√≥"
                }</td></tr>
                <tr><td class="font-weight-bold">S·ªë th·ª≠a ƒë·∫•t:</td><td>${
                  farmerPlots.length
                } th·ª≠a</td></tr>
                <tr><td class="font-weight-bold">T·ªïng di·ªán t√≠ch:</td><td>${totalArea.toFixed(
                  2
                )} km</td></tr>
              </table>
            </div>
          </div>
          ${plotsHtml}
        `;

        $("#farmerDetailModalTitle").text(`Chi ti·∫øt n√¥ng h·ªô - ${farmer.HoTen}`);
        $("#farmerDetailContent").html(farmerDetailContent);
        $("#farmerDetailModal").modal("show");
      }

      // Function ƒë·ªÉ populate dropdown n√¥ng h·ªô cho c√°c form kh√°c
      function populateFarmerDropdowns() {
        const selectors = ["#plotFarmer"];

        selectors.forEach((selector) => {
          const $select = $(selector);
          const currentVal = $select.val();
          $select.empty();
          $select.append('<option value="">Ch·ªçn n√¥ng h·ªô...</option>');

          // Group farmers by region for better UX
          const regionGroups = {};
          allFarmers.forEach((farmer) => {
            const region = allRegions.find((r) => r.MaVung == farmer.MaVung);
            const regionName = region ? region.TenVung : "Ch∆∞a x√°c ƒë·ªãnh v√πng";

            if (!regionGroups[regionName]) {
              regionGroups[regionName] = [];
            }
            regionGroups[regionName].push(farmer);
          });

          Object.keys(regionGroups)
            .sort()
            .forEach((regionName) => {
              if (regionGroups[regionName].length > 0) {
                const $optgroup = $(
                  `<optgroup label="${regionName}"></optgroup>`
                );
                regionGroups[regionName].forEach((farmer) => {
                  $optgroup.append(
                    `<option value="${
                      farmer.MaHo
                    }">NH${farmer.MaHo.toString().padStart(3, "0")} - ${
                      farmer.HoTen
                    }</option>`
                  );
                });
                $select.append($optgroup);
              }
            });

          if (currentVal) $select.val(currentVal);
        });
      }
    </script>

    <!-- Bootstrap core JavaScript-->
    <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="../../vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="../../js/sb-admin-2.min.js"></script>
    <script src="../../js/log_out_click_canBo.js"></script>

    <!-- Page level plugins -->
    <script src="../../vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="../../vendor/datatables/dataTables.bootstrap4.min.js"></script>
  </body>
</html>
